<?xml version="1.0"?>
<!DOCTYPE article PUBLIC "-//OASIS//DTD DocBook XML V4.1.2//EN" 
   "http://www.oasis-open.org/docbook/xml/4.1.2/docbookx.dtd" [
<!ENTITY psb2002 SYSTEM "psb2002.xml">
]>
<article class="techreport" status="draft">
  <articleinfo>
	<title>IHWG Analyses</title>
	<subtitle>Documentation for programs and methodology used for analyses
of the IHWG population data.</subtitle>

    <corpauthor><ulink url="http://allele5.biol.berkeley.edu">
          Thomson Lab</ulink></corpauthor>
      <author>
      <affiliation>
	<orgname><ulink url="http://www.berkeley.edu/">University of California, Berkeley</ulink></orgname>
	<orgdiv><ulink url="http://ib.berkeley.edu/">Department of Integrative Biology</ulink></orgdiv>
	<orgdiv></orgdiv>
	  </affiliation>
    </author>
	<releaseinfo>Version 0.1</releaseinfo>
	<pubdate>Last modified: $Date$ by $Author$</pubdate>
    
  </articleinfo>

  <sect1>
	<title>Introduction</title>

	<para>One of the goals of the IHWG is to analyze data generated by
the Anthropology component in the light of population genetics
theory. In this document we offer a detailed outline of the methods
used, their theoretical justification, the means by which they are
implemented. We also provide a list of future developments and the
status of the project.</para>
  </sect1>

  <sect1>
	<title>Population background data</title>

	<para>Information contained in the in the input file will be
reported as part of the output, in order to aid interpretation of
analyses.</para>

	<para>The following items will be reported for each population which is
analyzed. Note that this information concerns the population as a whole;
individual loci for that population may have different values with
respect to other fields (e.g. sample size).</para>

    <itemizedlist>
      <listitem><para>lab code</para>
	  </listitem>
	  <listitem><para>typing method</para>
	  </listitem>
	  <listitem><para>ethnicity</para>
	  </listitem>
	  <listitem><para>origin (?)</para>
	  </listitem>
	  <listitem><para>collection site</para>
	  </listitem>
	  <listitem><para>latitude</para>
	  </listitem>
	  <listitem><para>longitude</para>
	  </listitem>
	</itemizedlist>

  </sect1>

  <sect1>
	<title>Locus information and population genetics summary
	statistics</title>

	<para>For each locus, for a given population sample, report:</para>

	<itemizedlist>
	  <listitem>
        	<para>The <glossterm linkend="sample-size">sample size</glossterm> (in number of alleles)</para>
	  </listitem>

	  <listitem>
	       <para>The number of distinct alleles in the sample
                 (<glossterm linkend="locus-k"><varname>k</varname></glossterm>)
		</para>
	  </listitem>

	  <listitem>
		<para>The number of counts for each allele in the
		sample</para>
	  </listitem>
	  <listitem>
		<para>The gene diversity of the sample</para>
	  </listitem>
	</itemizedlist>

	<para>
	  Future work: include information about ambiguity of allelic
assignments.  For example, report how many allele calls are ambiguous
and maximum and minimum numbers of alleles (which will depend on how
the ambiguity is resolved). Report standard error of the estimate of
gene diversity (use resampling scheme for this?).</para>
  </sect1>

  <sect1>
	<title>Analyses</title>
	<sect2>
	  <title>Test for Hardy-Weinberg proportions</title>

	<variablelist>
	  <varlistentry>
		<term>Method</term>
		<listitem>
		  <para>Chi-square test of contingency table.</para>
		</listitem>
	  </varlistentry>
	  <varlistentry>
		<term>Input data</term>
		<listitem>
		  <para>single locus genotypes</para>
		</listitem>
	  </varlistentry>
		<varlistentry>
		  <term>Methodological outline</term>
		<listitem>
			<para>Compute observed and expected numbers of individuals
per genotypic category and test the null hypothesis of <glossterm
linkend="locus-hwe">HWE</glossterm> assuming
that deviations between observed and expected counts are chi-square
distributed. Cells for which the expected counts are lower than 5 are
pooled into a single class.</para>
</listitem>
		</varlistentry>
		<varlistentry>
		  <term>Output</term>
		<listitem>
			<para> The number of genotypes in the lumped category.
The number of degrees of freedom for the overall test.  The results
are displayed in a diagonal matrix, where each cell represents a
genotype. Cells along the diagonal are homozygotes.</para>

			<para>The test results are reported at three levels; 

<orderedlist numeration="loweralpha">
				<listitem>
				  <para>each cell's contribution to the overall
				  chi-square is reported; </para>
				</listitem>
				<listitem>
				  <para>the <varname>p-value</varname> for each
cell's deviation from <glossterm linkend="locus-hwe">HWE</glossterm> is computed (? is this a
1 d.f. test?); </para>
				</listitem>
				<listitem>
				  <para>the overall deviation of all the cells
from <glossterm linkend="locus-hwe">HWE</glossterm> is reported, in the form of an overall
chi-square value.</para>
				</listitem>
			  </orderedlist>
</para>
		  </listitem>
		</varlistentry>

		<varlistentry>
		  <term>Current status</term>
		  <listitem>
			<para> debugging code and verifying specifications, in
particular definition of the number of degrees of freedom for pooled
data.</para>
		  </listitem>
		</varlistentry>

		<varlistentry>
		  <term>Future work</term>
		  <listitem>
			<para>Implementation of exact test for contingency table,
using the MCMC algorithm. Implementation of individual genotype tests
for deviation from <acronym>HWE</acronym> using the test statistic described in John
Chen's dissertation. Estimation of standard error around
<varname>p-value</varname>s?  This can be done if resampling schemes
are used.</para>
		  </listitem>
		</varlistentry>

	</variablelist>
	</sect2>

	<sect2>
	  <title>Test of neutrality.</title>

	  <variablelist>
		<varlistentry>
		  <term>Method</term>
		  <listitem>
		  <para>Ewens-Watterson homozygosity test of neutrality</para>
		  </listitem>
		</varlistentry>

		<varlistentry>
		  <term>Input data</term>
		  <listitem>
			<para> single locus genotypes; only the allele count
information is used for this test.</para>
		  </listitem>
		</varlistentry>
		
		<varlistentry>
		  <term>Analysis</term>
		  <listitem>
			<para> Estimate sample homozygosity. Use tables of neutral
simulations to obtain expected <varname>F</varname> under neutrality,
and fraction of simulation results with <varname>F_exp</varname> that
exceeds <varname>F_obs</varname>, thus providing a <varname>p-value</varname> for the
null hypothesis of neutrality.  In the cases where there is no
simulated <varname>2n</varname> value that matches that of the sample
use the next higher <varname>2n</varname>, which will be conservative
with respect the rejection of neutrality (explain in more
detail).</para>
		  </listitem>
		</varlistentry>

		<varlistentry>
		  <term>Output</term>
		  <listitem>
			<para><varname>F_obs</varname>, <varname>F_exp</varname>,
			<varname>p-value</varname></para>
		  </listitem>
		</varlistentry>

		<varlistentry>
		  <term>Current status</term>
		  <listitem>
			<para>Complete, requires formatting.</para>
		  </listitem>
		</varlistentry>

		<varlistentry>
		  <term>Future work</term>
		  <listitem>
		  <para> Implement exact version of the test, which examines the
distribution of homozygosity over all possible configurations of
alleles, following Monty Slatkin's program. Also consider implementing the
version of a test of neutrality that uses the probability of the
configuration under neutrality (using the Ewens sampling
formula).</para>
		  </listitem>
		</varlistentry>
	  </variablelist>
	</sect2>

	<sect2>
	  <title>
		Estimation of haplotype frequencies from multilocus genotypic
data.</title>

	  <variablelist>

		<varlistentry>
		  <term>Method</term> 

		  <listitem><para><firstterm>Expectation-Maximization</firstterm>
		  (<acronym>EM</acronym>) algorithm.</para>
		  </listitem>
		</varlistentry>

		<varlistentry>
		  <term>Input data</term>
		  <listitem><para> Multilocus genotype data.</para>
		  </listitem>
		</varlistentry>

		<varlistentry>
		  <term>Methodological outline</term> 

		  <listitem><para> Using the <acronym>EM</acronym> algorithm, find the
		  maximum likelihood estimate of haplotype frequencies.</para>
		  </listitem>
		</varlistentry>

		<varlistentry>
		  <term>Output</term> 

		  <listitem><para>Estimated frequency of all haplotypes that
		  are estimated to occur with a frequency above an arbitrarily
		  set (low) threshold.</para>
		  </listitem>
		</varlistentry>

		<varlistentry>
		  <term>Current status</term> 

		  <listitem><para> Code written in C, requires testing and
		  integration with the remainder of the programs.</para>
		  </listitem>
		</varlistentry>

		<varlistentry>
		  <term>Future work</term> 

		  <listitem><para> Provide guidelines for
		  <acronym>EM</acronym> parameters (number of starting
		  conditions used) that are required to obtain reliable
		  estimates. Estimate and report standard errors of haplotype
		  frequency estimates; this may be done using a resampling
		  method.</para>
		  </listitem>
		</varlistentry>
	  </variablelist>
	</sect2>

	<sect2>
	  <title>Estimation of linkage disequilibrium values and
<varname>p-value</varname>s for a test of the null hypothesis that the
data is in linkage equilibrium.</title>

	  <variablelist>

		<varlistentry>
		  <term>Method</term> 

		  <listitem>
			<orderedlist numeration="loweralpha">
			  <listitem>
				<para>Use inferred haplotypes to estimate <acronym>LD</acronym> values;</para>
			  </listitem>
			  <listitem>
				<para>use likelihood ratio to test the null hypothesis
that the data is in <acronym>HW</acronym> equilibrium.</para>
			  </listitem>
			</orderedlist>
		  </listitem>
		</varlistentry>
		
		<varlistentry>
		  <term>Input data</term>

		  <listitem>
			<itemizedlist>
			  <listitem>
				<para> Multilocus genotype data, from which haplotypes
are inferred; these are then used to estimate haplotypes from which
<acronym>LD</acronym> measures are estimated.</para>
			  </listitem>
			  <listitem>
				<para> Multilocus genotypes are used to perform a
likelihood ratio test of the null hypothesis of linkage
equilibrium.</para>
			  </listitem>
			</itemizedlist>
		  </listitem>
		</varlistentry>

		<varlistentry>
		  <term>Methodological outline</term>

		  <listitem><itemizedlist> 

			  <listitem>
				<para>For each pair of loci report tables with cells
containing the values for (a) the observed and (b) the expected (under
<acronym>HWE</acronym>) number of counts. Each cell refers to a
specific two locus haplotype.</para>
			  </listitem>

			  <listitem>
				<para>Chi-square values for each two locus haplotype.</para>
			  </listitem>

			  <listitem>
				<para><acronym>LD</acronym> value for all pairs of alleles.</para>
			  </listitem>

			  <listitem>
				<para><acronym>LD</acronym> value (normalized) for all
				pairs of alleles.</para>
			  </listitem>

			  <listitem>
				<para>Disequilibrium summary measures
(<varname>Wn</varname>, <varname>Q</varname>, <varname>D'</varname>)
which provide an overall measure of the degree of deviation from
linkage equilibrium for the pair of loci.</para>
			  </listitem>
			</itemizedlist>
		  </listitem>
		</varlistentry>

		<varlistentry>
		  <term>Output</term>
		  <listitem><para>Not yet defined</para>
		  </listitem>
		</varlistentry>
		
		<varlistentry>
		  <term>Future work</term>

		  <listitem><para> Implementation of likelihood ratio test of
linkage equilibrium.  Testing of programme, addition of outputs for
<varname>p-value</varname>s for the null hypothesis of linkage
equilibrium, for both the individual and overall measures of
<acronym>LD</acronym>. Consider feasibility of developing exact test
for testing of linkage equilibrium using <acronym>MCMC</acronym>
approach (as heuristic for Fisher's exact test).</para>
</listitem>
		</varlistentry>
	  </variablelist>
	</sect2>
  </sect1>
  <glossary>
    <glossdiv>
      <title>Population attributes</title>
      <glossentry>
	<glossterm><varname>n</varname></glossterm>
	<glosssee otherterm="sample-size">sample size</glosssee>
      </glossentry>
      <glossentry id="sample-size">
	<glossterm>sample size</glossterm>
	<glossdef>
	  <para>Number of individuals in sample (can be total in
	  population or total within a locus).</para>
	</glossdef>
      </glossentry>

      <glossentry>
	<glossterm>population name, lab code, typing method,
	ethnicity, origin, collection site, latitude,
	longtitude</glossterm>
	<glossdef>
	  <para>Header information that should be provided for each
	  file.</para>
	</glossdef>
      </glossentry>
    </glossdiv>

    <glossdiv>
      <title>Locus</title>
      <glossentry id="locus-k">
	<glossterm><varname>k</varname></glossterm>
	<glossdef>
	  <para>Number of distinct allelic variants at a locus.</para>
	</glossdef>
      </glossentry>
      <glossentry id="locus-hwe">
	<glossterm>Hardy-Weinberg Equilibrium</glossterm>
	<acronym>HWE</acronym>
	<glossdef>
	  <para>Hardy-Weinberg equilibrium is an "ideal" randomly
	  mating population not undergoing selection.</para>
	</glossdef>
      </glossentry>
    </glossdiv>
  </glossary>

  <appendix>
    <title>Data interchange</title>
    <section>
      <title>Data format</title>

      <para>File format is plain ASCII, with fields delimited by
       tabstops, not spaces.  Fields are separated by tabs so that
       spaces are permitted within a field.  The file suffix should
       be <filename>.txt</filename></para>

      <para>No field may be left blank.  Four asterisks should be used
       to designate untyped locus data or unknown descriptive data.</para>

      <para>There should be 3 lines of header information on a
      population file.</para>

      <para>The three lines are as follows:</para>

      <programlistingco>
	<areaspec>
	  <area label="line1" linkends="line1-co" coords="1" id="line1"/>
	  <area coords="2" id="line2"/>
	  <area coords="3" id="line3"/>
	</areaspec>
	<programlisting>labcode	method	ethnic	contin	collect	latit	longit	complex
USAERL  SSOP    Irish   Europe  Dublin  30 deg  350 deg 1
populat id	a_1	a_2	c_1	c_2	b_1	b_2	tap1_1	tap1_2
</programlisting>
	<calloutlist>
	  <callout arearefs="line1" id="line1-co" xreflabel="line1">
	    <formalpara>
	      <title>Line 1</title>
	      <para>Column headers</para>
	    </formalpara>
	  </callout>
	  <callout arearefs="line2">

	    <formalpara>
	      <title>Line 2</title> 
	      <para>Data under headings in line
	      1 are filled in on line 2 as follows:</para>
	    </formalpara>

	    <para>The <literal>method</literal> should be one of the
following:</para> 
<literallayout format="linespecific">SSOP
RLS
SBT
SSP
RSCA
MS<footnote><para>(this is for PCR/gel sizing for microsatellites)</para></footnote>
RFLP
SSCP
Other
</literallayout>

	    <para>The <literal>ethnic</literal> field may contain
            practically anything, but the <literal>contin</literal>
            field should contain one of the following geographic
            regions:</para>
	    <literallayout>
North-Africa
Sub-Saharan-Africa
North-East-Asia
South-East-Asia
South-West-Asia
Australia
Europe
North-America
Oceania
South-America
Other
</literallayout>

	    <para>The <literal>collect</literal> field is for where
             the data was collected, <literal>latit</literal> and
             <literal>longit</literal> are for the latitude and
             longitude (approximately) of origin, and
             <literal>complex</literal> should be entered as a
             zero.</para>
	  </callout>
	  <callout arearefs="line3">
	    <formalpara>
	      <title>Line 3</title>
	    <para>There is one more line which contains the headers
            for the columns of genotype data.</para>
	    </formalpara>

	    <para><literal>populat</literal> should contain a name for
             the population and <literal>id</literal> should contain a
             sample id.</para>

	    <para> There should be two header labels for each locus,
            giving the name of the locus, in lower case please,
            followed by an underscore and a one (1) or a two
            (2), so that each column name is unique.</para>

	    <para>From <phrase role="strong">line 4</phrase> onwards,
            the file should contain genotype data, all tab-separated,
            with no blanks and a string of four asterisks indicating
            untyped loci.</para>

	   <para><emphasis role="bold">VERY IMPORTANT</emphasis>, a
            homozygote should include entries for both alleles i.e.,
            <literal>DRB1</literal> <literal>0407</literal> should
            have <literal>0407</literal> entered TWICE, the other
            allele should NEVER be left blank, indicated by a dash, or
            in any way assumed, otherwise they cannot be
            differentiated from ambiguous typing results.</para>

	    <para>There should be no trailing blank lines at the end
	    of a file.</para>

	  </callout>
	</calloutlist>
      </programlistingco>

    </section>

    <section>
      <title>Data transmission</title>

      <para>Possible methods:</para>

      <orderedlist>
	<listitem>
	  <para>e-mail the data files.</para>
	</listitem>

	<listitem>
	  <para>You log in to our server via <command>[s]ftp</command>
and upload the text files, alerting us by e-mail.</para>
	</listitem>

	<listitem>
	  <para>You alert us by e-mail when new data is available, and
we log in to your server via <command>[s]ftp</command> and download
the text files.</para>
	</listitem>
      </orderedlist>
    </section>
  </appendix>

  <appendix>
    <title>Data dictionary</title>
    <remark>This is from mpn's original in
    <filename>properties.txt</filename> and needs to be massaged into
    reasonable XML.</remark>
<programlisting>Species:
	# things that can be said about more than one population
	name

Population:
	# things that can be said about a single population
	name
	Lab code
	typing method
	ethnicity
	origin
	collection site
	latitude
	longtitude
	sample size # perhaps this should move to locus?

	patient or control # does this belong in Individual?
	patient vs. control overall chi-squared
	patient vs. control overall p-value
	patient vs. control degrees of freedom

	number of 2-way haplotypes
	frequency of 2-way haplotypes
	W
	Wnorm
	chi-squared
	G

	number of 3-way haplotypes
	frequency of 3-way haplotypes

	average dn
	average ds

Individual:
	# things that can be said about one record
	family_id
	individual_id
	age
	set of alleles

Locus:
	name
	number of alleles
	set of alleles
	HWP p-value
	HWP p-value standard error

	observed F
	expected F
	quantile
	F-variance
	FND

	gene diversity index

	synonymous differences
	non-synonymous differences

Haplotype:
	number of loci
	set of loci
	observed
	frequency
	expected
	d for each pairing
	d' for each pairing

Allele:
	name
	observed
	frequency
	expected
	patient vs. control chi-squared
	patient vs. control p-value
</programlisting>
  </appendix>

  <appendix>
    <title><application>PyPop</application>: software
    framework</title>

    <section>
      <title>Design</title>

    <para>The overall data and work flow for
    <application>PyPop</application>, the software framework for
    parsing the data files is shown in <xref linkend="pypop:work-flow"/>. </para>

    <para>A sample UML use-case is given in <xref linkend="pypop:design"/>.
    This indicates the processing steps involved the calculation of
    single statistic.  Note the exact object and method names are
    schematic only and may be out-of-date with respect to the current
    implementation.</para>


    <figure id="pypop:work-flow">
      <title>Work flow</title>
      <mediaobject>
	<imageobject>
	  <imagedata fileref="work-flow.eps" align="center"/>
	</imageobject>
	<imageobject>
	  <imagedata fileref="work-flow.png" align="center"/>
	</imageobject>
	<textobject>
	  <phrase>Diagram of software workflow can be found at: http://allele5.biol.berkeley.edu/ihwg/work-flow.png</phrase>
	</textobject>
      </mediaobject>
    </figure>

    <figure id="pypop:design">
      <title>Schematic UML design</title>
      <mediaobject>
	<imageobject>
	  <imagedata fileref="design.png" align="center"/>
	</imageobject>
	<textobject>
	  <phrase>Digram of UML design can be found at: http://allele5.biol.berkeley.edu/ihwg/design.png</phrase>
	</textobject>
      </mediaobject>
    </figure>
    </section>

    <section>
      <title>API (Application Programmers Interface)</title>

    <para>The current <application>PyPop</application> Application
    Programmers Interface (API), can be found at:  <ulink
    url="api/index.html">API</ulink>.  A UML diagram of the class
    diagram is shown in <xref linkend="pypop:api"/>.</para>


    <figure id="pypop:api">
      <title>UML diagram of API</title>
      <mediaobject>
	<imageobject>
	  <imagedata fileref="api.png" align="center"/>
	</imageobject>
	<textobject>
	  <phrase>Digram of UML API can be found at: http://allele5.biol.berkeley.edu/ihwg/api.png</phrase>
	</textobject>
      </mediaobject>
    </figure>
    </section>

  </appendix>

  &psb2002;

</article>

<!--
Local variables:
sgml-local-catalogs: ("catalog")
End:
-->