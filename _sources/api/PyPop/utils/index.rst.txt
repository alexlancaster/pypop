PyPop.utils
===========

.. py:module:: PyPop.utils

.. autoapi-nested-parse::

   Module for common utility classes and functions.

   Contains convenience classes for output of text and XML
   files.



Attributes
----------

.. autoapisummary::

   PyPop.utils.GENOTYPE_SEPARATOR
   PyPop.utils.GENOTYPE_TERMINATOR


Classes
-------

.. autoapisummary::

   PyPop.utils.TextOutputStream
   PyPop.utils.XMLOutputStream
   PyPop.utils.StringMatrix
   PyPop.utils.Group


Functions
---------

.. autoapisummary::

   PyPop.utils.critical_exit
   PyPop.utils.getStreamType
   PyPop.utils.glob_with_pathlib
   PyPop.utils.natural_sort_key
   PyPop.utils.unique_elements
   PyPop.utils.appendTo2dList
   PyPop.utils.convertLineEndings
   PyPop.utils.fixForPlatform
   PyPop.utils.copyfileCustomPlatform
   PyPop.utils.copyCustomPlatform
   PyPop.utils.checkXSLFile
   PyPop.utils.getUserFilenameInput
   PyPop.utils.splitIntoNGroups


Module Contents
---------------

.. py:data:: GENOTYPE_SEPARATOR
   :value: '~'


   Separator between genotypes

   .. rubric:: Example

   In a haplotype
   ``01:01~13:01~04:02``

.. py:data:: GENOTYPE_TERMINATOR
   :value: '~'


   Terminator of genotypes

   .. rubric:: Example

   ```02:01:01:01~``

.. py:class:: TextOutputStream(file)

   Output stream for writing text files.

   :param file: file handle
   :type file: file


   .. py:method:: write(str)

      Write to stream.

      :param str: string to write
      :type str: str



   .. py:method:: writeln(str='\n')

      Write a newline to stream.

      :param str: defaults to newline
      :type str: str, optional



   .. py:method:: close()

      Close stream.



   .. py:method:: flush()

      Flush to disk.



.. py:class:: XMLOutputStream(file)

   Bases: :py:obj:`TextOutputStream`

   .. autoapi-inheritance-diagram:: PyPop.utils.XMLOutputStream
      :parts: 1


   Output stream for writing XML files.


   .. py:method:: opentag(tagname, **kw)

      Write an open XML tag to stream.

      Tag attributes passed as optional named keyword arguments.

      .. rubric:: Example

      ``opentag('tagname', role=something, id=else)``

      produces the result:

      ``<tagname role="something" id="else">``

      Attribute and values are optional:

      ``opentag('tagname')``

      Produces:

      ``<tagname>``

      .. seealso:: Must be be followed by a :meth:`closetag`.

      :param tagname: name of XML tag
      :type tagname: str



   .. py:method:: emptytag(tagname, **kw)

      Write an empty XML tag to stream.

      This follows the same syntax as :meth:`opentag` but without
      XML content (but can contain attributes).

      .. rubric:: Example

      ```emptytag('tagname', attr='val')``

      produces:

      ``<tagname attr="val"/>``

      :param tagname: name of XML tag
      :type tagname: str



   .. py:method:: closetag(tagname)

      Write a closing XML tag to stream.

      .. rubric:: Example

      ``closetag('tagname')``

      Generate a tag in the form:

      ``</tagname>``

      .. seealso:: Must be be preceded by a :meth:`opentag`.

      :param tagname: name of XML tag
      :type tagname: str



   .. py:method:: tagContents(tagname, content, **kw)

      Write XML tags around contents to a stream.

      .. rubric:: Example

      ``tagContents('tagname', 'foo bar')``

      produces:

      ``<tagname>foo bar</tagname>```

      :param tagname: name of XML tag
      :type tagname: str
      :param content: must only be a string. ``&``, ``<`` and
                      ``>`` are converted into valid XML equivalents.
      :type content: str



.. py:class:: StringMatrix(rowCount=None, colList=None, extraList=None, colSep='\t', headerLines=None)

   Bases: :py:obj:`collections.abc.Sequence`

   .. autoapi-inheritance-diagram:: PyPop.utils.StringMatrix
      :parts: 1


   Matrix of strings and other metadata from input file to PyPop.

   ``StringMatrix`` is a subclass of
   :class:`collections.abc.Sequence` and represents genotype or
   locus-based data in a row-oriented matrix structure with
   NumPy-style indexing and sequence semantics. Rows correspond to
   individuals, and columns correspond to loci.

   The object supports indexing, assignment, copying, and printing
   using standard Python and NumPy idioms.

   :param rowCount: number of rows in matrix
   :type rowCount: int
   :param colList: list of locus keys in a specified order
   :type colList: list
   :param extraList: other non-matrix metadata
   :type extraList: list
   :param colSep: column separator
   :type colSep: str
   :param headerLines: list of lines in the header of original file
   :type headerLines: list

   .. note::

      * ``len(matrix)`` returns the number of rows.
      * Indexing retrieves data by locus or locus combinations.
      * Assignment updates genotype or metadata values in place.
      * Slicing over rows (e.g., ``matrix[i:j]``) is not currently supported.
      * Deep copying produces a fully independent matrix.

   .. rubric:: Examples

   Create a matrix of two individuals with two loci and assign genotype data:

   >>> matrix = StringMatrix(2, ["A", "B"])
   >>> matrix [0, "A"] = ("A0_1", "A0_2")
   >>> matrix [1, "A"] = ("A1_1", "A1_2")
   >>> matrix [0, "B"] = ("B0_1", "B0_2")
   >>> matrix [1, "B"] = ("B1_1", "B1_2")

   Length of matrix is defined as the number of individuals in the
   matrix:

   >>> len(matrix)
   2

   Retrieve data for a single locus:

   >>> matrix["A"]
   [['A0_1', 'A0_2'], ['A1_1', 'A1_2']]

   String representation:

   >>> print (matrix)
   StringMatrix([['A0_1', 'A0_2', 'B0_1', 'B0_2'],
          ['A1_1', 'A1_2', 'B1_1', 'B1_2']], dtype=object)

   Copying the matrix:

   >>> import copy
   >>> m2 = copy.deepcopy(matrix)
   >>> m2 is matrix
   False


   .. py:method:: __repr__()

      Override default representation.

      :returns: new string representation
      :rtype: str



   .. py:method:: __len__()

      Get number of rows (individuals) in the matrix.

      This allows ``StringMatrix`` instances to be used with
      `len()`, iteration, and other Python sequence protocols.

      :returns: number of rows in the matrix
      :rtype: int



   .. py:method:: __deepcopy__(memo)

      Create a deepcopy for ``copy.deepcopy``.

      This simply calls ``self.copy()`` to allow
      ``copy.deepcopy(matrixInstance)`` to work out of the box.

      :param memo: opaque object
      :type memo: dict

      :returns: copy of the matrix
      :rtype: StringMatrix



   .. py:method:: __getslice__(i, j)

      Get slice (overrides built-in).

      .. warning:: Currently not supported for :class:`StringMatrix`



   .. py:method:: __getitem__(key)

      Get the item at given key (overrides built-in numpy).

      :param key: locus key
      :type key: str

      :returns: a list (a single column vector if only one position
                specified), or list of lists: (a set of column vectors if
                several positions specified) of tuples for ``key``
      :rtype: list

      :raises KeyError: if key is not found, or of wrong type



   .. py:method:: __setitem__(index, value)

      Set the value at an index (override built in).

      :param index: index into matrix
      :type index: tuple
      :param value: can set using a tuple of strings, or a
                    single string (for metadata)
      :type value: tuple|str

      :raises IndexError: if ``index`` is not a tuple
      :raises ValueError: if ``value`` is not a tuple or string
      :raises KeyError: if the ``index`` can't be found



   .. py:method:: dump(locus=None, stream=sys.stdout)

      Write file to a stream in original format.

      :param locus: write just specified locus, if
                    omitted, default to all loci
      :type locus: str, optional
      :param stream: output stream
      :type stream: TextOutputStream|XMLOutputStream|stdout



   .. py:method:: copy()

      Make a (deep) copy.

      :returns: a deep copy of the current object
      :rtype: StringMatrix



   .. py:method:: getNewStringMatrix(key)

      Create new StringMatrix containing specified loci.

      .. note::

         The format of the keys is identical to :meth:`__getitem__`
         except that it returns a full ``StringMatrix`` instance
         which includes all metadata

      :param key: a string representing the loci, using the
                  ``locus1:locus2`` format
      :type key: str

      :returns: full instance
      :rtype: StringMatrix

      :raises KeyError: if locus can not be found.



   .. py:method:: getUniqueAlleles(key)

      Get naturally sorted list of unique alleles.

      :param key: loci to get
      :type key: str

      :returns: list of unique integers sorted by allele name using
                natural sort
      :rtype: list



   .. py:method:: convertToInts()

      Convert the matrix to integers.

      .. note::

         This function is used by the :class:`PyPop.haplo.Haplostats`
         class.  Note that integers start at 1 for compatibility with
         haplo-stats module

      :returns: matrix where the original allele names are now
                represented by integers
      :rtype: StringMatrix



   .. py:method:: countPairs()

      Count all possible pairs of haplotypes for each matrix row.

      .. warning::

         This does *not* do any involved handling of missing data as
         per ``geno.count.pairs`` from R ``haplo.stats`` module.

      :returns: each element is the number of pairs in row order
      :rtype: list



   .. py:method:: flattenCols()

      Flatten columns into a single list.

      .. important:: Currently assumes entries are integers.

      :returns: all alleles, the two genotype columns concatenated
                for each locus
      :rtype: list



   .. py:method:: filterOut(key, blankDesignator)

      Get matrix rows filtered by a designator.

      :param key: locus to filter
      :type key: str
      :param blankDesignator: string to exclude
      :type blankDesignator: str

      :returns: the rows of the matrix that *do not* contain
                ``blankDesignator`` at any rows
      :rtype: list



   .. py:method:: getSuperType(key)

      Get a matrix grouped by specified key.

      .. rubric:: Example

      Return a new matrix with the column vector with the alleles
      for each genotype concatenated like so:

      >>> matrix = StringMatrix(2, ["A", "B"])
      >>> matrix[0, "A"] = ("A01", "A02")
      >>> matrix[1, "A"] = ("A11", "A12")
      >>> matrix[0, "B"] = ("B01", "B02")
      >>> matrix[1, "B"] = ("B11", "B12")
      >>> print(matrix)
      StringMatrix([['A01', 'A02', 'B01', 'B02'],
             ['A11', 'A12', 'B11', 'B12']], dtype=object)
      >>> matrix.getSuperType("A:B")
      StringMatrix([['A01:B01', 'A02:B02'],
             ['A11:B11', 'A12:B12']], dtype=object)

      :param key: loci to group
      :type key: str

      :returns: a new matrix with the columns concatenated
      :rtype: StringMatrix



.. py:class:: Group(li, size)

   Group list or sequence into non-overlapping chunks.

   .. rubric:: Example

   >>> for pair in Group('aabbccddee', 2):
   ...    print(pair)  # doctest: +NORMALIZE_WHITESPACE
   ...
   aa
   bb
   cc
   dd
   ee

   >>> a = Group('aabbccddee', 2)
   >>> a[0]
   'aa'
   >>> a[3]
   'dd'

   :param li: string or list
   :type li: str|list
   :param size: size of grouping
   :type size: int


   .. py:method:: __getitem__(group)

      Get the item by position.

      :param group: get the item by position
      :type group: int

      :returns: the value at that position
      :rtype: str|list

      :raises IndexError: if ``group`` is out of bounds



.. py:function:: critical_exit(message, *args)

   Log a CRITICAL message and exit with status 1.

   .. versionadded:: 1.4.0

   :param message: Logging format string.
   :type message: str


.. py:function:: getStreamType(stream)

   Get the type of stream.

   :param stream: stream to check
   :type stream: TextOutputStream|XMLOutputStream

   :returns: either ``xml`` or ``text``.
   :rtype: string


.. py:function:: glob_with_pathlib(pattern)

   Use globbing with ``pathlib``.

   :param pattern: globbing pattern
   :type pattern: str

   :returns: of pathlib globs
   :rtype: list


.. py:function:: natural_sort_key(s, _nsre=re.compile('([0-9]+)'))

   Generate a key for natural (human-friendly) sorting.

   This function splits a string into text and number components so that
   numbers are compared by value instead of lexicographically. It is
   intended for use as the ``key`` function in :meth:`list.sort` or
   :func:`sorted`.

   .. rubric:: Example

   >>> items = ["item2", "item10", "item1"]
   >>> sorted(items, key=natural_sort_key)
   ['item1', 'item2', 'item10']

   :param s: The string to split into text and number components.
   :type s: str
   :param _nsre: Precompiled regular expression used internally
                 to split the string into digit and non-digit chunks. This is
                 not intended to be overridden in normal use.
   :type _nsre: Pattern

   :returns: A list of strings and integers to be used as a sort key.
   :rtype: list


.. py:function:: unique_elements(li)

   Gets the unique elements in a list.

   :param li: a list
   :type li: list

   :returns: unique elements
   :rtype: list


.. py:function:: appendTo2dList(aList, appendStr=':')

   Append a string to each element in a list.

   :param aList: list to append to
   :type aList: list
   :param appendStr: string to append
   :type appendStr: str

   :returns: a list with string appended to each element
   :rtype: list


.. py:function:: convertLineEndings(file, mode)

   Convert line endings based on platform.

   :param file: file name to convert
   :type file: str
   :param mode: Conversion mode, one of

                - ``1`` Unix to Mac
                - ``2`` Unix to DOS
   :type mode: int


.. py:function:: fixForPlatform(filename, txt_ext=0)

   Fix for some Windws/MS-DOS platforms.

   :param filename: path to file
   :type filename: str
   :param txt_ext: if enabled (``1``) add a ``.txt`` extension
   :type txt_ext: int, optional


.. py:function:: copyfileCustomPlatform(src, dest, txt_ext=0)

   Copy file to file with fixes.

   :param src: source file
   :type src: str
   :param dest: source file
   :type dest: str
   :param txt_ext: if enabled (``1``) add a ``.txt`` extension
   :type txt_ext: int, optional


.. py:function:: copyCustomPlatform(file, dist_dir, txt_ext=0)

   Copy file to directory with fixes.

   :param file: source file
   :type file: str
   :param dist_dir: source directory
   :type dist_dir: str
   :param txt_ext: if enabled (``1``) add a ``.txt`` extension
   :type txt_ext: int, optional


.. py:function:: checkXSLFile(xslFilename, path='', subdir='', abort=False, msg='')

   Check XSL filename and return full path.

   :param xslFilename: name of the XSL file
   :type xslFilename: str
   :param path: root path to check
   :type path: str
   :param subdir: subdirectory under ``path`` to check
   :type subdir: str
   :param abort: if enabled (``True``) file isn't found, exit with
                 an error.  Default is ``False``
   :type abort: bool
   :param msg: output message on abort
   :type msg: str

   :returns: checked and validaated path
   :rtype: str


.. py:function:: getUserFilenameInput(prompt, filename)

   Get user filename input.

   Read user input for a filename, check its existence, continue
   requesting input until a valid filename is entered.

   :param prompt: description of file
   :type prompt: str
   :param filename: default filename
   :type filename: str

   :returns: name of file eventually selected
   :rtype: str


.. py:function:: splitIntoNGroups(alist, n=1)

   Divides a list up into n parcels (plus whatever is left over).

   .. rubric:: Example

   >>> a = ['A', 'B', 'C', 'D', 'E']
   >>> splitIntoNGroups(a, 2)
   [['A', 'B'], ['C', 'D'], ['E']]

   :param alist: list to divide up
   :type alist: list
   :param n: parcel size
   :type n: int

   :returns: list of lists
   :rtype: list


